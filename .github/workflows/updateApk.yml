name: Flutter APK & AAB Build and GitHub Release

on:
  push:
    tags:
      - 'v*.*.*' # å½“æœ‰ä»¥ 'v' å¼€å¤´çš„æ ‡ç­¾è¢«æ¨é€åˆ°ä»“åº“æ—¶è§¦å‘ï¼Œä¾‹å¦‚ v1.0.0

jobs:
  build_and_release:
    runs-on: ubuntu-latest # æˆ–è€… windows-latest, macos-latest

    steps:
      - name: Checkout Repository # æ­¥éª¤1: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–æ‰€æœ‰å†å²ï¼ŒåŒ…æ‹¬æ ‡ç­¾ï¼Œä»¥ä¾¿Gitæ“ä½œ

      - name: Setup Flutter # æ­¥éª¤2: è®¾ç½® Flutter ç¯å¢ƒ
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable' # ä½¿ç”¨ stable é€šé“
          # å¦‚æœæ‚¨éœ€è¦ç‰¹å®šç‰ˆæœ¬çš„Flutterï¼Œå¯ä»¥åœ¨è¿™é‡ŒæŒ‡å®šï¼Œä¾‹å¦‚ version: '3.19.6'

      - name: Get Flutter Version # æ­¥éª¤3: è·å– Flutter ç‰ˆæœ¬ä¿¡æ¯ (å¯é€‰ï¼Œç”¨äºæ—¥å¿—)
        run: flutter --version

      - name: Cache Flutter dependencies # æ­¥éª¤4: ç¼“å­˜ Flutter ä¾èµ–ï¼ŒåŠ å¿«åç»­æ„å»º
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            # å¦‚æœæ‚¨çš„é¡¹ç›®æœ‰ç‰¹å®šçš„æ„å»ºç¼“å­˜ç›®å½•ï¼Œå¯ä»¥æ·»åŠ ï¼Œä¾‹å¦‚ï¼š
            # android/.gradle
            # android/app/build # è¿™ä¸æ˜¯ä¸€ä¸ªå¥½çš„ç¼“å­˜è·¯å¾„ï¼Œå› ä¸ºæ„å»ºäº§ç‰©å˜åŠ¨å¤§
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Install dependencies # æ­¥éª¤5: å®‰è£… Flutter ä¾èµ–
        run: flutter pub get

      - name: Run code generation (if build_runner is used) # æ­¥éª¤6: å¦‚æœå­˜åœ¨ build_runnerï¼Œè¿è¡Œä»£ç ç”Ÿæˆ
        id: run_codegen # æ·»åŠ ä¸€ä¸ªIDä»¥ä¾¿åç»­åˆ¤æ–­
        run: |
          if grep -q "build_runner" pubspec.yaml; then
            echo "build_runner detected in pubspec.yaml. Running code generation..."
            flutter packages pub run build_runner build --delete-conflicting-outputs
            echo "::set-output name=codegen_ran::true"
          else
            echo "build_runner not found in pubspec.yaml, skipping code generation."
            echo "::set-output name=codegen_ran::false"
          fi
        # å³ä½¿ä»£ç ç”Ÿæˆå¤±è´¥ä¹Ÿç»§ç»­æ‰§è¡Œï¼Œä½†ä¼šè®°å½•è­¦å‘Š
        continue-on-error: true

      - name: Report code generation status # æ‰“å°ä»£ç ç”Ÿæˆç»“æœ (å¯é€‰)
        if: steps.run_codegen.outputs.codegen_ran == 'true' && failure()
        run: echo "::warning::Code generation step encountered errors, but the workflow is continuing."

      - name: Build Android APK # æ­¥éª¤7: æ„å»º Release APK
        run: flutter build apk --release --verbose # ä¿æŒ --verbose ä»¥è·å–è¯¦ç»†æ—¥å¿—

      - name: Build Android App Bundle (AAB) # æ­¥éª¤8: æ„å»º Release AAB (æ¨èç”¨äºGoogle Play)
        run: flutter build appbundle --release --verbose
        continue-on-error: true # AABæ„å»ºå¤±è´¥ä¸å½±å“APKä¸Šä¼ ï¼Œå¯æ ¹æ®éœ€æ±‚è°ƒæ•´

      - name: List generated Artifacts # æ­¥éª¤9: åˆ—å‡ºç”Ÿæˆçš„ APK å’Œ AAB æ–‡ä»¶ (ç”¨äºç¡®è®¤å’Œæ—¥å¿—)
        run: |
          echo "Listing APK files in release directory:"
          ls -lh android/app/build/outputs/apk/release/ || echo "APK release directory not found."
          echo ""
          echo "Listing AAB files in app bundle release directory:"
          ls -lh android/app/build/outputs/bundle/release/ || echo "AAB release directory not found."

      - name: Upload APK as artifact # æ­¥éª¤10: å°† APK æ–‡ä»¶ä½œä¸ºæ„å»ºäº§ç‰©ä¸Šä¼ ï¼Œæ–¹ä¾¿ä¸‹è½½å’ŒæŸ¥çœ‹
        uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: android/app/build/outputs/apk/release/invest_ledger-release.apk # ç²¾ç¡®æŒ‡å®šæ–‡ä»¶å

      - name: Upload AAB as artifact (Optional) # æ­¥éª¤11: å°† AAB æ–‡ä»¶ä½œä¸ºæ„å»ºäº§ç‰©ä¸Šä¼  (å¯é€‰)
        uses: actions/upload-artifact@v4
        with:
          name: release-aab
          path: android/app/build/outputs/bundle/release/app-release.aab # AABé€šå¸¸æ˜¯è¿™ä¸ªé»˜è®¤åç§°
        continue-on-error: true # å¦‚æœæ²¡æœ‰AABæ–‡ä»¶ä¹Ÿä¸æŠ¥é”™

      - name: Get current tag # æ­¥éª¤12: ä»è§¦å‘äº‹ä»¶ä¸­è·å–å½“å‰æ ‡ç­¾ä½œä¸ºç‰ˆæœ¬å·
        id: get_tag
        run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release # æ­¥éª¤13: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2 # ä½¿ç”¨ç¬¬ä¸‰æ–¹Actionæ¥åˆ›å»ºRelease
        with:
          tag_name: ${{ steps.get_tag.outputs.TAG_NAME }}
          name: Release ${{ steps.get_tag.outputs.TAG_NAME }}
          body: |
            ğŸ‰ New Release ${{ steps.get_tag.outputs.TAG_NAME }}
            
            # Release Notes
            
            è¯·ä»ä»¥ä¸‹é™„ä»¶ä¸‹è½½ APK å’Œ/æˆ– AAB æ–‡ä»¶ã€‚
          draft: false # æ ¹æ®éœ€æ±‚è®¾ç½®ä¸º true æˆ– false
          prerelease: false # æ ¹æ®éœ€æ±‚è®¾ç½®ä¸º true æˆ– false
          files: |
            android/app/build/outputs/apk/release/invest_ledger-release.apk # ä¸Šä¼ APKæ–‡ä»¶åˆ°Releaseèµ„äº§ä¸­
            android/app/build/outputs/bundle/release/app-release.aab # ä¸Šä¼ AABæ–‡ä»¶åˆ°Releaseèµ„äº§ä¸­ (å¦‚æœå­˜åœ¨)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # è¿™æ˜¯ä¸€ä¸ªGitHub Actions è‡ªåŠ¨æä¾›çš„Secretï¼Œæ‹¥æœ‰åˆ›å»ºReleaseçš„æƒé™