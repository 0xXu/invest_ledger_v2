name: Flutter APK Build and GitHub Release

on:
  push:
    tags:
      - 'v*.*.*' # å½“æœ‰ä»¥ 'v' å¼€å¤´çš„æ ‡ç­¾è¢«æ¨é€åˆ°ä»“åº“æ—¶è§¦å‘ï¼Œä¾‹å¦‚ v1.0.0

jobs:
  build_and_release:
    runs-on: ubuntu-latest # æˆ–è€… windows-latest, macos-latest

    steps:
      - name: Checkout Repository # æ­¥éª¤1: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–æ‰€æœ‰å†å²ï¼ŒåŒ…æ‹¬æ ‡ç­¾ï¼Œä»¥ä¾¿Gitæ“ä½œ

      - name: Setup Flutter # æ­¥éª¤2: è®¾ç½® Flutter ç¯å¢ƒ
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable' # ä½¿ç”¨ stable é€šé“

      - name: Get Flutter Version # æ­¥éª¤3: è·å– Flutter ç‰ˆæœ¬ä¿¡æ¯ (å¯é€‰ï¼Œç”¨äºæ—¥å¿—)
        run: flutter --version

      - name: Cache Flutter dependencies # æ­¥éª¤4: ç¼“å­˜ Flutter ä¾èµ–ï¼ŒåŠ å¿«åç»­æ„å»º
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            build/
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Install dependencies # æ­¥éª¤5: å®‰è£… Flutter ä¾èµ–
        run: flutter pub get

      - name: Run code generation (if build.yaml exists) # æ­¥éª¤6: å¦‚æœå­˜åœ¨ build.yamlï¼Œè¿è¡Œä»£ç ç”Ÿæˆ
        run: |
          if [ -f build.yaml ]; then
            echo "Running code generation..."
            flutter packages pub run build_runner build --delete-conflicting-outputs
          else
            echo "build.yaml not found, skipping code generation."
          fi
        # ç»§ç»­æ‰§è¡Œï¼Œå³ä½¿ä»£ç ç”Ÿæˆå¤±è´¥ï¼Œç±»ä¼¼äºæ‚¨çš„Pythonè„šæœ¬é€»è¾‘
        continue-on-error: true

      - name: Build Android APK # æ­¥éª¤7: æ„å»º Release APK
        run: flutter build apk --release

      - name: List generated APKs # æ­¥éª¤8: åˆ—å‡ºç”Ÿæˆçš„ APK æ–‡ä»¶ (ç”¨äºç¡®è®¤å’Œæ—¥å¿—)
        run: |
          echo "Listing APK files in release directory:"
          ls -lh android/app/build/outputs/apk/release/
          echo "Listing APK files in app bundle directory:"
          ls -lh android/app/build/outputs/bundle/release/ # æ£€æŸ¥æ˜¯å¦ä¹Ÿç”Ÿæˆäº†aabæ–‡ä»¶

      - name: Upload APK as artifact # æ­¥éª¤9: å°† APK æ–‡ä»¶ä½œä¸ºæ„å»ºäº§ç‰©ä¸Šä¼ ï¼Œæ–¹ä¾¿ä¸‹è½½å’ŒæŸ¥çœ‹
        uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: android/app/build/outputs/apk/release/*.apk # ä¸Šä¼ æ‰€æœ‰ç”Ÿæˆçš„APKæ–‡ä»¶
          # path: build/ # ä¹Ÿå¯ä»¥ä¸Šä¼ åˆ°è¿™ä¸ªè·¯å¾„ä¸‹å¤åˆ¶çš„APKï¼Œå¦‚æœæ‚¨çš„Pythonè„šæœ¬ç¡®ä¿äº†å¤åˆ¶

      - name: Get current tag # æ­¥éª¤10: ä»è§¦å‘äº‹ä»¶ä¸­è·å–å½“å‰æ ‡ç­¾ä½œä¸ºç‰ˆæœ¬å·
        id: get_tag
        run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release # æ­¥éª¤11: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2 # ä½¿ç”¨ç¬¬ä¸‰æ–¹Actionæ¥åˆ›å»ºRelease
        with:
          tag_name: ${{ steps.get_tag.outputs.TAG_NAME }}
          name: Release ${{ steps.get_tag.outputs.TAG_NAME }}
          body: |
            ğŸ‰ New Release ${{ steps.get_tag.outputs.TAG_NAME }}
            
            # Release Notes
            
            # ä¸‹è½½
            è¯·ä»ä»¥ä¸‹é™„ä»¶ä¸‹è½½ APK æ–‡ä»¶ã€‚
          draft: false # æ ¹æ®éœ€æ±‚è®¾ç½®ä¸º true æˆ– false
          prerelease: false # æ ¹æ®éœ€æ±‚è®¾ç½®ä¸º true æˆ– false
          files: |
            android/app/build/outputs/apk/release/*.apk # ä¸Šä¼ APKæ–‡ä»¶åˆ°Releaseèµ„äº§ä¸­
            # å¦‚æœæ‚¨æƒ³ä¸Šä¼ åˆ°buildç›®å½•ä¸‹çš„ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ build/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # è¿™æ˜¯ä¸€ä¸ªGitHub Actions è‡ªåŠ¨æä¾›çš„Secretï¼Œæ‹¥æœ‰åˆ›å»ºReleaseçš„æƒé™