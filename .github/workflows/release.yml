name: ğŸš€ Release Build and Deploy

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)"
        required: true
        type: string
      release_notes:
        description: "å‘å¸ƒè¯´æ˜"
        required: false
        type: string
        default: ""
      prerelease:
        description: "æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬"
        required: false
        type: boolean
        default: false

env:
  FLUTTER_VERSION: "3.32.0"
  JAVA_VERSION: "17"

jobs:
  # æ„å»ºAndroid APK
  build-android:
    name: ğŸ¤– æ„å»º Android APK
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: â˜• è®¾ç½® Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}

      - name: ğŸ¦ è®¾ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: ğŸ“¦ è·å–ä¾èµ–
        run: |
          flutter pub get
          flutter pub run build_runner build --delete-conflicting-outputs

      - name: Clean Flutter build artifacts
        run: flutter clean

      - name: ğŸ”§ åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶
        run: |
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" > .env
          echo "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" >> .env

      - name: ğŸ”‘ è®¾ç½® Android ç­¾å
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/upload-keystore.jks
          echo "storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" > android/key.properties
          echo "keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}" >> android/key.properties
          echo "storeFile=../upload-keystore.jks" >> android/key.properties
          echo "org.gradle.jvmargs=-Xmx4096m" >> android/gradle.properties
          echo "org.gradle.vfs.watch=false" >> android/gradle.properties

      - name: ğŸ—ï¸ æ„å»º APK
        run: |
          cd android
          # æ£€æŸ¥gradlewæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          ls -la
          # ç¡®ä¿gradlewæœ‰æ‰§è¡Œæƒé™
          chmod +x ./gradlew
          ./gradlew app:assembleRelease

          mkdir -p ../build/app/outputs/flutter-apk/
          cp app/build/outputs/apk/release/*.apk ../build/app/outputs/flutter-apk/

          echo "Generated APKs:"
          ls -l app/build/outputs/apk/release/
          echo "Copied to Flutter build dir:"
          ls -l ../build/app/outputs/flutter-apk/

      - name: ğŸ“‹ ç”Ÿæˆæ„å»ºä¿¡æ¯
        run: |
          echo "## ğŸ“± Android æ„å»ºä¿¡æ¯" > build_info.md
          echo "" >> build_info.md
          echo "- **æ„å»ºæ—¶é—´**: $(date)" >> build_info.md
          echo "- **Flutterç‰ˆæœ¬**: ${{ env.FLUTTER_VERSION }}" >> build_info.md
          echo "- **Javaç‰ˆæœ¬**: ${{ env.JAVA_VERSION }}" >> build_info.md
          echo "- **Gitæäº¤**: ${{ github.sha }}" >> build_info.md
          echo "" >> build_info.md
          echo "### ğŸ“¦ æ„å»ºäº§ç‰©" >> build_info.md
          echo "" >> build_info.md
          ls -la build/app/outputs/flutter-apk/ >> build_info.md
          echo "" >> build_info.md
          ls -la build/app/outputs/bundle/release/ >> build_info.md

      - name: ğŸ“¤ ä¸Šä¼  APK æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: android-apks
          path: |
            build/app/outputs/flutter-apk/*.apk
            build/app/outputs/bundle/release/*.aab
            build_info.md
          retention-days: 30

  # æ„å»ºWindowsåº”ç”¨
  build-windows:
    name: ğŸªŸ æ„å»º Windows åº”ç”¨
    runs-on: windows-latest

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ¦ è®¾ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: ğŸ“¦ è·å–ä¾èµ–
        run: |
          flutter pub get
          flutter pub run build_runner build --delete-conflicting-outputs

      - name: ğŸ”§ åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶
        run: |
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" > .env
          echo "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" >> .env

      - name: ğŸ—ï¸ æ„å»º Windows åº”ç”¨
        run: |
          flutter build windows --release

      - name: ğŸ“¦ æ‰“åŒ… Windows åº”ç”¨
        run: |
          Compress-Archive -Path "build\windows\x64\runner\Release\*" -DestinationPath "invest_ledger_windows.zip"

      - name: ğŸ“¤ ä¸Šä¼  Windows æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: windows-app
          path: invest_ledger_windows.zip
          retention-days: 30

  # åˆ›å»ºGitHub Release
  create-release:
    name: ğŸ‰ åˆ›å»º GitHub Release
    needs: [build-android, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ğŸ“‹ å‡†å¤‡å‘å¸ƒæ–‡ä»¶
        run: |
          mkdir -p release_files

          # å¤åˆ¶Android APKæ–‡ä»¶
          cp artifacts/android-apks/*.apk release_files/ || true
          cp artifacts/android-apks/*.aab release_files/ || true

          # å¤åˆ¶Windowsåº”ç”¨
          cp artifacts/windows-app/*.zip release_files/ || true



          # åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶
          echo "ğŸ“¦ å‘å¸ƒæ–‡ä»¶åˆ—è¡¨:"
          ls -la release_files/

      - name: ğŸ“ ç”Ÿæˆå‘å¸ƒè¯´æ˜
        id: release_notes
        run: |
          # è·å–ç‰ˆæœ¬å·
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            RELEASE_NOTES="${{ github.event.inputs.release_notes }}"
            IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
            RELEASE_NOTES=""
            IS_PRERELEASE="false"
          fi

          # ç”Ÿæˆå‘å¸ƒè¯´æ˜
          cat > release_notes.md << EOF
          # ğŸ‰ InvestLedger v${VERSION}

          ${RELEASE_NOTES}

          ## ğŸ“± æ”¯æŒå¹³å°

          - **Android**: APKæ–‡ä»¶æ”¯æŒ ARM64ã€ARMv7ã€x86_64 æ¶æ„
          - **Windows**: æ”¯æŒ x64 æ¶æ„

          ## ğŸ“¦ ä¸‹è½½è¯´æ˜

          ### Android ç”¨æˆ·
          - ä¸‹è½½å¯¹åº”æ¶æ„çš„APKæ–‡ä»¶ç›´æ¥å®‰è£…
          - æ¨èä¸‹è½½ \`app-arm64-v8a-release.apk\` (é€‚ç”¨äºå¤§å¤šæ•°ç°ä»£Androidè®¾å¤‡)

          ### Windows ç”¨æˆ·
          - ä¸‹è½½ \`invest_ledger_windows.zip\`
          - è§£å‹åè¿è¡Œ \`invest_ledger.exe\`


          ## ğŸ”§ ç³»ç»Ÿè¦æ±‚

          - **Android**: Android 5.0 (API 21) æˆ–æ›´é«˜ç‰ˆæœ¬
          - **Windows**: Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬

          ## ğŸ“ æ›´æ–°æ—¥å¿—

          æŸ¥çœ‹å®Œæ•´æ›´æ–°æ—¥å¿—è¯·è®¿é—®: [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)

          ---

          **æ„å»ºä¿¡æ¯**
          - æ„å»ºæ—¶é—´: $(date)
          - Gitæäº¤: ${{ github.sha }}
          - Flutterç‰ˆæœ¬: ${{ env.FLUTTER_VERSION }}
          EOF

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "is_prerelease=${IS_PRERELEASE}" >> $GITHUB_OUTPUT

      - name: ğŸš€ åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && format('v{0}', github.event.inputs.version) || github.ref_name }}
          name: ${{ format('InvestLedger v{0}', steps.release_notes.outputs.version) }}
          body_path: release_notes.md
          files: release_files/*
          draft: false
          prerelease: ${{ steps.release_notes.outputs.is_prerelease == 'true' }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“Š å‘å¸ƒç»Ÿè®¡
        run: |
          echo "ğŸ‰ Releaseåˆ›å»ºæˆåŠŸ!"
          echo "ğŸ“Š å‘å¸ƒç»Ÿè®¡:"
          echo "- ç‰ˆæœ¬: ${{ steps.release_notes.outputs.version }}"
          echo "- é¢„å‘å¸ƒ: ${{ steps.release_notes.outputs.is_prerelease }}"
          echo "- æ–‡ä»¶æ•°é‡: $(ls -1 release_files/ | wc -l)"
          echo "- æ€»å¤§å°: $(du -sh release_files/ | cut -f1)"

  # é€šçŸ¥ä»»åŠ¡ (å¯é€‰)
  notify:
    name: ğŸ“¢ å‘å¸ƒé€šçŸ¥
    needs: [create-release]
    runs-on: ubuntu-latest
    if: always() && (startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch')

    steps:
      - name: ğŸ“¢ å‘å¸ƒæˆåŠŸé€šçŸ¥
        if: needs.create-release.result == 'success'
        run: |
          echo "âœ… å‘å¸ƒæˆåŠŸå®Œæˆ!"
          echo "ğŸ”— Releaseé“¾æ¥: https://github.com/${{ github.repository }}/releases"

      - name: âŒ å‘å¸ƒå¤±è´¥é€šçŸ¥
        if: needs.create-release.result == 'failure'
        run: |
          echo "âŒ å‘å¸ƒè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯!"
          echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—å¹¶é‡è¯•ã€‚"
