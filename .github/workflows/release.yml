name: ðŸš€ Release Build and Deploy

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)"
        required: true
        type: string
      release_notes:
        description: "å‘å¸ƒè¯´æ˜Ž"
        required: false
        type: string
        default: ""
      prerelease:
        description: "æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬"
        required: false
        type: boolean
        default: false

env:
  FLUTTER_VERSION: "3.32.0"
  JAVA_VERSION: "17"

jobs:
  # æž„å»ºAndroid APK
  build-android:
    name:  æž„å»º Android APK
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}

      - name: è®¾ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Clean Flutter build artifacts
        run: flutter clean

      - name: èŽ·å–ä¾èµ–
        run: |
          flutter pub get
          flutter pub run build_runner build --delete-conflicting-outputs

      - name: åˆ›å»ºçŽ¯å¢ƒé…ç½®æ–‡ä»¶
        run: |
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" > .env
          echo "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" >> .env

      - name: è®¾ç½® Android ç­¾å
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/upload-keystore.jks
          echo "storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" > android/key.properties
          echo "keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}" >> android/key.properties
          echo "storeFile=../upload-keystore.jks" >> android/key.properties
          echo "org.gradle.jvmargs=-Xmx4096m" >> android/gradle.properties
          echo "org.gradle.vfs.watch=false" >> android/gradle.properties

      - name: ç”Ÿæˆ Gradle Wrapper
        run: |
          cd android
          gradle wrapper

      - name: è®¾ç½®ç‰ˆæœ¬å·
        run: |
          # èŽ·å–ç‰ˆæœ¬å·
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi

          # ä»Žpubspec.yamlèŽ·å–å½“å‰ç‰ˆæœ¬å·å’Œæž„å»ºå·
          PUBSPEC_VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //')
          VERSION_NAME=$(echo $PUBSPEC_VERSION | cut -d'+' -f1)
          BUILD_NUMBER=$(echo $PUBSPEC_VERSION | cut -d'+' -f2)

          echo "ðŸ“± ç‰ˆæœ¬ä¿¡æ¯:"
          echo "  - pubspec.yamlç‰ˆæœ¬: $PUBSPEC_VERSION"
          echo "  - ç‰ˆæœ¬åç§°: $VERSION_NAME"
          echo "  - æž„å»ºå·: $BUILD_NUMBER"

          # å¦‚æžœæ˜¯æ‰‹åŠ¨è§¦å‘æˆ–æ ‡ç­¾è§¦å‘ï¼Œä½¿ç”¨æŒ‡å®šçš„ç‰ˆæœ¬å·
          if [[ -n "$VERSION" ]]; then
            VERSION_NAME="$VERSION"
            echo "  - ä½¿ç”¨æŒ‡å®šç‰ˆæœ¬: $VERSION_NAME"
          fi

          # è®¾ç½®çŽ¯å¢ƒå˜é‡ä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV

      - name:  æž„å»º APK
        run: |
          echo "FLUTTER_ROOT=$FLUTTER_HOME" >> $GITHUB_ENV
          cd $GITHUB_WORKSPACE

          # ä½¿ç”¨çŽ¯å¢ƒå˜é‡ä¼ é€’ç‰ˆæœ¬ä¿¡æ¯ç»™Gradle
          ./android/gradlew -p android assembleRelease \
            -PversionName=$VERSION_NAME \
            -PversionCode=$BUILD_NUMBER

          # åˆ—å‡ºå®žé™…è¾“å‡ºç›®å½•ä»¥è¿›è¡Œè°ƒè¯•
          echo "æ£€æŸ¥ APK è¾“å‡ºä½ç½®ï¼š"
          find android -name "*.apk" -type f

          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p build/app/outputs/flutter-apk/

          # ä½¿ç”¨æ­£ç¡®çš„è·¯å¾„å¤åˆ¶ APK
          find android -name "*.apk" -type f -exec cp {} build/app/outputs/flutter-apk/ \;

          echo "ç”Ÿæˆçš„ APKï¼š"
          ls -l android/app/build/outputs/apk/release/ || echo "android/app/build/outputs/apk/release/ ä¸­æ²¡æœ‰ APK"
          echo "å¤åˆ¶åˆ° Flutter æž„å»ºç›®å½•ï¼š"
          ls -l build/app/outputs/flutter-apk/

      - name: ç”Ÿæˆæž„å»ºä¿¡æ¯
        run: |
          echo "## ðŸ“± Android æž„å»ºä¿¡æ¯" > build_info.md
          echo "" >> build_info.md
          echo "- **æž„å»ºæ—¶é—´**: $(date)" >> build_info.md
          echo "- **Flutterç‰ˆæœ¬**: ${{ env.FLUTTER_VERSION }}" >> build_info.md
          echo "- **Javaç‰ˆæœ¬**: ${{ env.JAVA_VERSION }}" >> build_info.md
          echo "- **Gitæäº¤**: ${{ github.sha }}" >> build_info.md
          echo "" >> build_info.md
          echo "### ðŸ“¦ æž„å»ºäº§ç‰©" >> build_info.md
          echo "" >> build_info.md
          ls -la build/app/outputs/flutter-apk/ >> build_info.md

      - name: ðŸ“¤ ä¸Šä¼  APK æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: android-apks
          path: |
            build/app/outputs/flutter-apk/*.apk
            build_info.md
          retention-days: 30

  # æž„å»ºWindowsåº”ç”¨
  build-windows:
    name: æž„å»º Windows åº”ç”¨
    runs-on: windows-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name:  è®¾ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name:  èŽ·å–ä¾èµ–
        run: |
          flutter pub get
          flutter pub run build_runner build --delete-conflicting-outputs

      - name:  åˆ›å»ºçŽ¯å¢ƒé…ç½®æ–‡ä»¶
        run: |
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" > .env
          echo "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" >> .env

      - name:  æž„å»º Windows åº”ç”¨
        run: |
          flutter build windows --release

      - name: æ‰“åŒ… Windows åº”ç”¨
        run: |
          Compress-Archive -Path "build\windows\x64\runner\Release\*" -DestinationPath "invest_ledger_windows.zip"

      - name: ä¸Šä¼  Windows æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: windows-app
          path: invest_ledger_windows.zip
          retention-days: 30

  # åˆ›å»ºGitHub Release
  create-release:
    name: åˆ›å»º GitHub Release
    needs: [build-android, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
        run: |
          mkdir -p release_files

          # åˆ—å‡ºä¸‹è½½çš„æž„å»ºäº§ç‰©ç›®å½•ç»“æž„ä»¥ä¾¿è°ƒè¯•
          echo "ä¸‹è½½çš„æž„å»ºäº§ç‰©ç›®å½•ç»“æž„:"
          find artifacts -type f | sort

          # å¤åˆ¶Android APKæ–‡ä»¶ - ä½¿ç”¨findå‘½ä»¤æ›´å¯é åœ°æŸ¥æ‰¾å’Œå¤åˆ¶æ–‡ä»¶
          find artifacts/android-apks -name "*.apk" -exec cp {} release_files/ \; || echo "æœªæ‰¾åˆ°Android APKæ–‡ä»¶"

          # å¤åˆ¶Windowsåº”ç”¨
          cp artifacts/windows-app/*.zip release_files/ || echo "æœªæ‰¾åˆ°Windowsåº”ç”¨æ–‡ä»¶"

          # åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶
          echo "å‘å¸ƒæ–‡ä»¶åˆ—è¡¨:"
          ls -la release_files/

      - name:  ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
        id: release_notes
        run: |
          # èŽ·å–ç‰ˆæœ¬å·
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            RELEASE_NOTES="${{ github.event.inputs.release_notes }}"
            IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
            RELEASE_NOTES=""
            IS_PRERELEASE="false"
          fi

          echo "ç‰ˆæœ¬å·: $VERSION"
          echo "æ˜¯å¦é¢„å‘å¸ƒ: $IS_PRERELEASE"

          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT

          # ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
          cat > release_notes.md << EOF
          # InvestLedger v${VERSION}

          ${RELEASE_NOTES}


          ## ðŸ“ æ›´æ–°æ—¥å¿—

          - ç»Ÿä¸€ç›ˆäºé‡‘é¢æ˜¾ç¤ºæ ¼å¼ï¼Œç§»é™¤æ­£è´Ÿå·å‰ç¼€
          - ç®€åŒ–ç”¨æˆ·æ³¨å†Œæµç¨‹ï¼Œç§»é™¤å†—ä½™çš„ç”¨æˆ·å­˜åœ¨æ£€æŸ¥
          - å¢žå¼ºCSVå¯¼å…¥é”™è¯¯å¤„ç†å’Œæ˜¾ç¤ºåŠŸèƒ½
          - ä¸ºç›®æ ‡è¿›åº¦å¡ç‰‡æ·»åŠ åŠ¨ç”»æ•ˆæžœå’Œè§†è§‰å¢žå¼º

          ---

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && format('v{0}', github.event.inputs.version) || github.ref_name }}
          name: InvestLedger v${{ steps.release_notes.outputs.version }}
          body_path: release_notes.md
          files: release_files/*
          draft: false
          prerelease: ${{ steps.release_notes.outputs.is_prerelease == 'true' }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: å‘å¸ƒç»Ÿè®¡
        run: |
          echo "Releaseåˆ›å»ºæˆåŠŸ!"
          echo "å‘å¸ƒç»Ÿè®¡:"
          echo "- ç‰ˆæœ¬: ${{ steps.release_notes.outputs.version }}"
          echo "- é¢„å‘å¸ƒ: ${{ steps.release_notes.outputs.is_prerelease }}"
          echo "- æ–‡ä»¶æ•°é‡: $(ls -1 release_files/ | wc -l)"
          echo "- æ€»å¤§å°: $(du -sh release_files/ | cut -f1)"

